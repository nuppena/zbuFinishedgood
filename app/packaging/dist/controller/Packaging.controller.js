sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/BusyIndicator","sap/m/MessageBox","pcf/com/acc/packaging/finishedgoods/service/odataHelper","sap/ui/model/Filter","sap/ui/model/FilterOperator"],(e,t,o,s,n,i)=>{"use strict";return e.extend("pcf.com.acc.packaging.finishedgoods.Packaging",{onInit(){var e=this;this.userID="demoTestUser";this.PackagingState=this.getOwnerComponent().getState("Packaging");this.PackagingService=this.getOwnerComponent().getService("Packaging");this.oGlobalBusyDialog=new sap.m.BusyDialog;if(sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService){sap.ushell.Container.getServiceAsync("UserInfo").then(function(t){if(t){var o=t.getId();e.userID=t.getEmail();e.onAPIExecute()}}).catch(function(e){console.error("Error getting UserInfo service:",e)})}else{console.warn("SAP Fiori Launchpad shell services not available. User information may not be accessible.")}},onDownloadTemplate:function(){var e="Finished_Goods.xlsx";var t=sap.ui.require.toUrl(`pcf/com/acc/packaging/finishedgoods/DownloadTemplate/${e}`);const o=document.createElement("a");o.href=t;o.style.display="none";document.body.appendChild(o);o.click();document.body.removeChild(o)},onFileSelected:function(e){const t=e.getParameter("files")[0];if(t){this._selectedFile=t}},loadXLSXLibrary:function(){return new Promise(function(e,t){if(window.XLSX){e();return}var o=document.createElement("script");o.src=jQuery.sap.getModulePath("pcf.com.acc.packaging.finishedgoods.lib","/xlsx.full.min.js");o.onload=function(){e()};o.onerror=function(){t("Failed to load XLSX library")};document.head.appendChild(o)})},onUploadFile:function(){if(!this._selectedFile){sap.m.MessageToast.show("Please select a file first.");return}const e=["Site ID","Finished Good ID","Finished Good Weight(kg)"];const t=this;this.loadXLSXLibrary().then(function(){var s=new FileReader;s.onload=function(s){var n=s.target.result;var i=XLSX.read(n,{type:"binary"});var a=i.SheetNames[0];var r=i.Sheets[a];var l=XLSX.utils.sheet_to_json(r,{defval:""});if(!l||l.length===0){o.error("Please fill all the mandatory fields.");t.getView().getModel("excelData").setData({results:[]});return}let c=[];l.forEach((t,o)=>{let s=e.every(e=>t[e]&&t[e].toString().trim()!=="");if(!s){c.push(o+2)}});if(c.length>0){o.error("Please fill all the mandatory fields.\nMissing fields Row Numbers: "+c.join(", "));t.getView().getModel("excelData").setData({results:[]});return}t.getOwnerComponent().getModel("locModel").setProperty("/excelData",l);if(l||l.length>0){t.onSaveChanges()}if(t._oUploadDialog){t._oUploadDialog.close()}};s.readAsBinaryString(t._selectedFile)}).catch(function(e){console.error(e)})},onOpenUploadDialog:function(){const e=this.getView().byId("fileUploaderDialog");if(e){e.clear();this._selectedFile=""}if(!this._oUploadDialog){this._oUploadDialog=new sap.m.Dialog({title:"Upload Excel File",contentWidth:"400px",content:[new sap.ui.unified.FileUploader({id:this.createId("fileUploaderDialog"),name:"upload",fileType:["xlsx","csv"],change:this.onFileSelected.bind(this)})],beginButton:new sap.m.Button({text:"Upload",press:this.onUploadFile.bind(this)}),endButton:new sap.m.Button({text:"Close",press:function(){this._oUploadDialog.close()}.bind(this)})})}this._oUploadDialog.open()},handleTxtFilter:function(e){const t=e.getParameter("query").trim();if(!t){this.byId("ftable").getBinding("rows").filter([]);return}const o=[new n("Site ID",i.Contains,t),new n("Finished Good ID",i.Contains,t),new n("Error Status",i.Contains,t)];const s=parseFloat(t);if(!isNaN(s)){o.push(new n("Finished Good Weight(kg)",i.EQ,s),new n("Emission Intensity",i.EQ,s),new n("Emission Allocated to Final Good(Kgco2e)",i.EQ,s))}const a=new n({filters:o,and:false});this.byId("ftable").getBinding("rows").filter(a)},onSaveChanges:function(){const e=this;var t=this.getOwnerComponent().getModel("locModel").getProperty("/excelData");var n=new sap.ui.model.json.JSONModel;n.setData({results:t});if(!n||!n.getData().results||n.getData().results.length===0){o.warning("No data available to save.");return}const i=n.getData().results;const a=[];for(let e=0;e<i.length;e++){a.push({Site_ID:i[e]["Site ID"],Finished_Good_ID:i[e]["Finished Good ID"],Finished_Good_Weight:i[e]["Finished Good Weight(kg)"]})}const r={uName:this.userID,material:a};this.oGlobalBusyDialog.open();var l=this.getOwnerComponent().getModel();s.postData(l,"/loadFinishedGoods",r).then(t=>{if(t.loadFinishedGoods.Status=="200"){e.onRunExecute()}if(t.loadFinishedGoods.statusCode==502){let e=t.loadFinishedGoods.reason.response.body.error;o.error(e.split(":")[1]+":"+e.split(":")[2]);this.oGlobalBusyDialog.close()}}).catch(e=>{console.error("Error reading data:",e);this.oGlobalBusyDialog.close()})},onRunExecute:function(){const e=this;var t=this.getOwnerComponent().getModel();const o={uName:this.userID};s.postData(t,"/runFinishedGoods",o).then(t=>{if(t.runFinishedGoods.Message.result=="Batch emission values updated successfully."){e.onAPIExecute()}}).catch(t=>{console.error("Error reading data:",t);e.oGlobalBusyDialog.close()})},onAPIExecute:function(){const e=this;this.byId("ftable").setEnableBusyIndicator(true);var t=this.getOwnerComponent().getModel();const o={uName:this.userID};s.postData(t,"/fetchFinishedGoods",o).then(e=>{var t=e.fetchFinishedGoods.Message.result;var o=new sap.ui.model.json.JSONModel({results:t});this.getView().setModel(o,"excelData");this.getView().getModel().refresh(true);this.oGlobalBusyDialog.close();this.byId("ftable").setEnableBusyIndicator(false)}).catch(e=>{console.error("Error reading data:",e);this.oGlobalBusyDialog.close();this.byId("ftable").setEnableBusyIndicator(false)})},onImportExcel:function(){var e=this.byId("fileUploader");if(e){var t=e.getFocusDomRef();if(t){t.click()}else{setTimeout(()=>{e.$().find("input[type='file']").trigger("click")},0)}}},onExecute:function(){const e=this;this._chkFile().then(function(){return e._uploadFileExecute()})},_chkFile:function(){const e=this.getView().getModel("i18n").getResourceBundle();const t=this._getFileUploader().oFileUpload.files[0];return new Promise(function(s,n){if(typeof t===UIConstants.undefined){o.error(e.getText("fileValidation"));return n()}else{s()}})},_uploadFileExecute:function(){const e=this;return new Promise(async function(t,o){const s=e._getFileUploader();const n=s.oFileUpload.files[0];const i=n.name;sap.ui.getCore().fileUploadArr=[];const a=n.type;let r=await e._base64conversionMethod(a,i,n);if(r){let t={payload:[{data:r}]};e._sendPayload(t)}})},_base64conversionMethod:async function(e,t,o,s){return new Promise((n,i)=>{const a=this;if(!FileReader.prototype.readAsBinaryString){FileReader.prototype.readAsBinaryString=function(o){const n="";const i=new FileReader;i.onload=async function(o){const r=new Uint8Array(i.result);const l=r.byteLength;for(const e=0;e<l;e++){n+=String.fromCharCode(r[e])}a.base64ConversionRes=await btoa(n);sap.ui.getCore().fileUploadArr.push({DocumentType:s,MimeType:e,FileName:t,Content:a.base64ConversionRes})};i.readAsArrayBuffer(o)}}const r=new FileReader;r.onload=async function(o){const i=o.target.result;a.base64ConversionRes=await btoa(i);await sap.ui.getCore().fileUploadArr.push({DocumentType:s,MimeType:e,FileName:t,Content:a.base64ConversionRes});let r=(new sap.ui.getCore).fileUploadArr[0].Content;n(r)};r.readAsBinaryString(o)})},_sendPayload:async function(e){const t=this;const s=t.getView().getModel("i18n").getResourceBundle();return await this.PackagingService.uploadData(e).then(function(e){if(e.data){let s=e.data.status;if(s===UIConstants.successStatus){o.success(e.data.scheduleJob.message,{onClose:function(){t._resetFields()}})}else{o.error(e.data.scheduleJob.message,{onClose:function(){t._resetFields()}})}}else{o.error(s.getText("errorMsg"),{onClose:function(){t._resetFields()}})}}.bind(this),function(e){const s=JSON.parse(e.responseText).error.message.value;o.error(s,{onClose:function(){t._resetFields()}})}.bind(this))},_resetFields:function(){const e=this._getFileUploader();e.clear()},_getFileUploader:function(){return this.getView().byId("fileUploaderDialog")},onExport:function(){const e=this.getView().getModel("excelData");if(!e||!e.getData().results||e.getData().results.length===0){sap.m.MessageBox.warning("No data available to export.");return}const t=e.getData().results;this.loadXLSXLibrary().then(function(){var e=XLSX.utils.json_to_sheet(t);const o=["Site ID","Finished Good ID","Finished Good Weight(kg)","Emission Intensity","Emission Allocated to Final Good(Kgco2e)","Error Status"];const s=t.map(e=>Object.fromEntries(o.map(t=>[t,e[t]])));var e=XLSX.utils.json_to_sheet(s,{header:o});const n=XLSX.utils.book_new();XLSX.utils.book_append_sheet(n,e,"Exported Data");XLSX.writeFile(n,"Finished Goods.xlsx")}).catch(function(e){console.error(e)})}})});
//# sourceMappingURL=Packaging.controller.js.map